---
title: "potential_output"
author: "Ricardo Mayer"
date: "April 17, 2017"
output:
  html_document: default
  word_document:
    reference_docx: reference_word.docx
  pdf_document: default

---




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(printr)
```

```{r, load_libraries, include=FALSE}
library(dplyr) # use dplyr::first and dplyr::last
library(ggplot2)
library(xts) # use xts::first and xts::last
library(tidyr)
library(lubridate)
library(tibble)
library(tidyquant)
library(ggthemes)
library(knitr)
library(kableExtra)
library(countrycode)
library(readxl)
library(ggpubr)
```

```{r load_principal_data, cache=TRUE, include=FALSE}
load("../produced_data/WEOApr2017_cepal_and_others")

# what variables are available (not the same for countries and groups of countries!) ad what are their codes
subject_dict_co <- WEOApr2017cepal18_others_long %>% 
  filter(iso == "CHL" & year == 2000) %>% 
  select(-c(value, iso, country, country_series_specific_notes,
            weo_country_code, estimates_start_after, scale, year))

subject_dict_wo <- WEOApr2017cepal18_others_long %>% 
  filter(country == "World" & year == 2000) %>% 
  select(-c(value, iso,  country_series_specific_notes,
            weo_country_code, estimates_start_after, scale, year) ) 


load("../produced_data/cepal_18_countries")
load("../produced_data/cepal_33_countries")

weo_country_names_lac_18 <- countrycode(cepal_18_countries[["iso3c"]], "iso3c", "country.name.en")
weo_country_names_lac_18[2] <- "Bolivia"
weo_country_names_lac_18[18] <- "Venezuela"
```

## Producto potencial
```{r calculate_gdp_gaps_trends, include=FALSE}

source("../functions/funcs_for_new_normal.R")


weo_gdp <- WEOApr2017cepal18_others_long %>% 
  select(iso, country, year, weo_subject_code, value) %>% 
  filter(weo_subject_code %in% c("NGDP_R", "NGDP_RPCH", "NGAP_NPGDP")) 

real_gdp_long <- weo_gdp %>% 
  filter(weo_subject_code %in% c("NGDP_R")) %>% 
  mutate(date =  ymd(paste0(year,  "-12-31"))) 

# foo <- add_ts_filters(real_gdp_long , date_colname = "date", value_colname = "value", country_colname = "iso")

real_gdp_hp <- add_ts_filters(real_gdp_long) %>% arrange(country, date) %>% 
  group_by(country) %>% 
  mutate(trend_growth_pct = 100*(hp_trend / dplyr::lag(hp_trend)-1)    )

trend_growth_2003_2008 <- real_gdp_hp %>% 
  filter(year>=2003 & year <= 2008) %>% 
  summarise(avg_tg_2003_2008 = mean(trend_growth_pct))

trend_growth_2010_2016 <- real_gdp_hp %>% 
  filter(year>=2010 & year <= 2016) %>% 
  summarise(avg_tg_2010_2016 = mean(trend_growth_pct))

trend_growth_2003_2008_2010_2016 <- left_join(trend_growth_2003_2008,
                                              trend_growth_2010_2016,
                                              by = "country") %>% 
  mutate(dif = avg_tg_2010_2016 - avg_tg_2003_2008 )


trend_growth_2003_2008_2010_2016_lac <- trend_growth_2003_2008_2010_2016 %>% 
  filter(!country %in% c("China", "United States"))

trend_growth_2003_2008_2010_2016_usa_china <- trend_growth_2003_2008_2010_2016 %>% 
  filter(country %in% c("China", "United States"))  
  
real_gdp_country_wide <- real_gdp_long %>% 
  spread(key = country, value=value)

real_gdp_growth_long <- weo_gdp %>% 
  filter(weo_subject_code %in% c("NGDP_RPCH"))


weo_long_EU_AE_G7 <- subset(weo_gdp , 
                country %in% c("Major advanced economies (G7)",
                               "Euro area " , "Advanced economies")) %>% 
  select(-iso) %>% arrange(country, year)

weo_cwide_EU_AE_G7 <- weo_long_EU_AE_G7 %>% spread(weo_subject_code, value) %>% 
  group_by(country) %>% 
  mutate(gross_gap = 1 + NGAP_NPGDP/100,
         gross_rate_gdp = 1 + NGDP_RPCH/100,
         gross_rate_potetial_gdp = gross_rate_gdp*dplyr::lag(gross_gap)/gross_gap,
         growth_potential_pct = 100*(gross_rate_potetial_gdp-1))


EU_AE_G7_tg_2003_2008 <- weo_cwide_EU_AE_G7 %>% 
  filter(year>=2003 & year <= 2008) %>% 
  summarise(avg_tg_2003_2008 = mean(growth_potential_pct))

EU_AE_G7_tg_2010_2016 <- weo_cwide_EU_AE_G7 %>% 
  filter(year>=2010 & year <= 2016) %>% 
  summarise(avg_tg_2010_2016 = mean(growth_potential_pct))

trend_growth_AE_G7_EU_2003_2008_2010_2016 <- left_join(EU_AE_G7_tg_2003_2008,
                                                       EU_AE_G7_tg_2010_2016,
                                              by = "country") %>% 
  mutate(dif = avg_tg_2010_2016-avg_tg_2003_2008)

trend_growth_AE_G7_EU_2003_2008_2010_2016[3,1] <- "G7"

trend_growth_2003_2008_2010_2016_big_economies <- bind_rows(trend_growth_2003_2008_2010_2016_usa_china ,
                                                            trend_growth_AE_G7_EU_2003_2008_2010_2016) 
  
real_gdp_gap_weo_long <-  weo_gdp %>% 
  filter(weo_subject_code %in% c("NGAP_NPGDP"))

real_gdp_wide <- real_gdp_long %>% 
  spread(key=year, value=value)

real_gdp_growth_wide <- real_gdp_growth_long %>% 
  spread(key=year, value=value)

real_gdp_gap_weo_wide <- real_gdp_gap_weo_long %>% 
  spread(key=year, value=value)
```


```{r potential_gdp_extended_exam}

ponderadores_gdp <- read_excel("../raw_data/ponderadores_gdp.xlsx", sheet = "Sheet3") %>% 
  filter(iso2c != "suma") %>% 
  gather(key = year, value = pond, -iso2c)

growth_gdp_potencial_aravena  <- read_excel("../raw_data/PIB_potencial_rm.xlsx",
sheet = "Sheet2") %>% 
  gather(key = year, value = growth_pot_gdp, -iso2c)


real_gdp_lcu_long <- WEOApr2017cepal18_others_long %>% 
  filter(weo_subject_code %in% c("NGDP_R")) %>% 
  mutate(date =  ymd(paste0(year,  "-12-31"))) 

# real_gdp_lcu_long <- real_gdp_lcu_long %>% 
#   filter(year(date) <= 2015)

growth_gdp_p_a_filter <-  growth_gdp_potencial_aravena %>% 
  mutate(date =  ymd(paste0(year,  "-12-31"))) %>% 
  add_ts_filters(value_colname = "growth_pot_gdp", country_colname ="iso2c") 

exp_man <- c("MX","PA","GT","DO","CR","NI","SV","HN")
exp_oil <- c("BO", "CO", "EC", "VE")
exp_oil_no_ven <- c("BO", "CO", "EC", "VE")
exp_agro <- c("AR", "BR", "PY", "UY")
exp_min <- c("CL", "PE")

clasif <- list("manuf" = exp_man, "mining" = exp_min, "oil" = exp_oil, "oil_no_ven" = exp_oil_no_ven,
               "agro" = exp_agro)

real_gdp_lcu_filters <- add_ts_filters(real_gdp_lcu_long) %>% arrange(country, date) %>% 
  group_by(country) %>% 
  mutate(hp_trend_growth_pct = 100*(hp_trend / dplyr::lag(hp_trend)-1),
         cf_trend_growth_pct = 100*(cf_trend / dplyr::lag(cf_trend)-1),
         actual_gdp_growth_pct = 100*(value / dplyr::lag(value)-1),
         gdp_1990 = sum(value * (year == 1990), na.rm = TRUE),
         hp_trend_1990 = sum(hp_trend * (year == 1990), na.rm = TRUE),
         cf_trend_1990 = sum(cf_trend * (year == 1990), na.rm = TRUE),
         actual_gdp_base_1990 = value/gdp_1990,
         hp_trend_base_1990 = hp_trend/hp_trend_1990,
         cf_trend_base_1990 = cf_trend/cf_trend_1990,
         iso2c = countrycode(iso, "iso3c", "iso2c"),
         exp_group = if_else(iso2c %in% exp_man, "manuf", 
                             if_else(iso2c %in% exp_oil, "oil",
                                     if_else(iso2c %in% exp_min, "mining", "agro"))),
         exp_group_no_ven = if_else(iso2c == "VE", "VE", exp_group)
  ) 

real_gdp_lcu_filters_pfun <- real_gdp_lcu_filters %>% 
  select(-c(weo_country_code, subject_descriptor, subject_notes, estimates_start_after,
            units, scale, country_series_specific_notes)) %>% 
  left_join(ponderadores_gdp, by = c("iso2c", "year")) %>% 
  left_join(growth_gdp_p_a_filter, by = c("iso2c", "year"), suffix = c(".fil", ".p_fun"))


gr_lac_filters_pfun <- real_gdp_lcu_filters_pfun %>% 
  filter(iso2c %in% cepal_18_countries[["iso2c"]]) %>% 
  group_by(date.fil) %>% 
  summarise(w_gr_pfun = sum(100*growth_pot_gdp*pond),
            w_gr_pfun_hp = sum(100*hp_trend.p_fun*pond),
            w_gr_hp = sum(hp_trend_growth_pct*pond),
            w_gr_cf = sum(cf_trend_growth_pct*pond),
            w_gr_actual_gdp = sum(actual_gdp_growth_pct*pond),
            uw_gr_actual_gdp = mean(actual_gdp_growth_pct),
            uw_gr_hp = mean(hp_trend_growth_pct),
            uw_gr_pfun = mean(100*growth_pot_gdp),
            uw_gr_pfun_hp = mean(100*hp_trend.p_fun)) %>% 
  ungroup() %>% 
  filter(year(date.fil) >= 1990 & year(date.fil) <= 2015)


gr_lac16venbra_filters_pfun <- real_gdp_lcu_filters_pfun %>% 
  filter(iso2c %in% cepal_18_countries[["iso2c"]]) %>% 
  filter(!iso2c %in% c("BR", "VE")) %>% 
  group_by(date.fil) %>% 
  summarise(w_gr_pfun = sum(100*growth_pot_gdp*pond),
            w_gr_pfun_hp = sum(100*hp_trend.p_fun*pond),
            w_gr_hp = sum(hp_trend_growth_pct*pond),
            w_gr_cf = sum(cf_trend_growth_pct*pond),
            w_gr_actual_gdp = sum(actual_gdp_growth_pct*pond),
            uw_gr_actual_gdp = mean(actual_gdp_growth_pct),
            uw_gr_hp = mean(hp_trend_growth_pct),
            uw_gr_pfun = mean(100*growth_pot_gdp),
            uw_gr_pfun_hp = mean(100*hp_trend.p_fun)) %>% 
  ungroup() %>% 
  filter(year(date.fil) >= 1990 & year(date.fil) <= 2015)


gr_groups_filters_pfun <- real_gdp_lcu_filters_pfun %>% 
  filter(iso2c %in% cepal_18_countries[["iso2c"]]) %>% 
  group_by(date.fil, exp_group) %>% 
  summarise(w_gr_pfun = sum(100*growth_pot_gdp*pond),
            w_gr_pfun_hp = sum(100*hp_trend.p_fun*pond),
            w_gr_hp = sum(hp_trend_growth_pct*pond),
            w_gr_cf = sum(cf_trend_growth_pct*pond),
            w_gr_actual_gdp = sum(actual_gdp_growth_pct*pond),
            uw_gr_actual_gdp = mean(actual_gdp_growth_pct),
            uw_gr_hp = mean(hp_trend_growth_pct),
            uw_gr_pfun = mean(100*growth_pot_gdp),
            uw_gr_pfun_hp = mean(100*hp_trend.p_fun)) %>% 
  ungroup() %>% 
  filter(year(date.fil) >= 1990 & year(date.fil) <= 2015)

gr_lac_filters_pfun_xts <- as.xts(gr_lac_filters_pfun[,2:9], order.by = gr_lac_filters_pfun$date.fil) 


xticks = seq(1990, 2015, 3)



plot_lac18_wavg_gr_base <- ggplot(gr_lac_filters_pfun, aes(x = year(date.fil))) + 
  geom_line(aes(y = w_gr_hp, col = "HP"), size = 1.3) + 
  labs(title = "PIB potencial",
       x = "",
       y = "Crecimiento anual (%)") + 
   theme_classic2() +
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5)) + 
  scale_x_continuous(breaks = xticks)


plot_groups_uwavg_gr_pfun <- ggplot(gr_groups_filters_pfun, aes(x = year(date.fil), col = exp_group)) + 
  geom_line(aes(y = uw_gr_pfun), size = 1.3) + 
  theme_classic2() +
  scale_x_continuous(breaks = xticks) + 
  scale_colour_discrete(name  = "",
                            breaks = c("agro", "manuf", "mining", "oil"),
                            labels = c("Agricultural (Argentina, Brazil, Paraguay and Uruguay)", "Manufactures (Mexico, Dominican Republic and Central America", "Metals (Chile and Peru)", "Hydrocarbons (Bolivia, Colombia, Ecuador, Venezuela)")) +
  labs(title = "Potential GDP growth",
       subtitle = "By main export categories",
       x = "",
       y = "Growth (%)",
       color = "",
       caption = "Source: WEO, April 2017 and ECLAC. Simple averages of country-level trend GDP growth rates.\n For each country, potential GDP is obtained by estimating a production function") +
  guides(color = guide_legend(ncol = 2)) + 
  theme(legend.position = "bottom",
         plot.title = element_text(hjust = 0.5), 
         plot.subtitle = element_text(hjust = 0.5),
         plot.caption = element_text(size = 8, hjust = 0),
         legend.key.size = unit(0.4, "cm")) 

plot_groups_uwavg_gr_hp <- ggplot(gr_groups_filters_pfun, aes(x = year(date.fil), col = exp_group)) + 
  geom_line(aes(y = uw_gr_hp), size = 1.3) + 
  theme_classic2() +
  scale_x_continuous(breaks = xticks) + 
  scale_colour_discrete(name  = "",
                            breaks = c("agro", "manuf", "mining", "oil"),
                            labels = c("Agricultural (Argentina, Brazil, Paraguay and Uruguay)", "Manufactures (Mexico, Dominican Republic and Central America", "Metals (Chile and Peru)", "Hydrocarbons (Bolivia, Colombia, Ecuador, Venezuela)")) +
  labs(title = "Trend GDP growth",
       subtitle = "By main export categories",
       x = "",
       y = "Growth (%)",
       color = "",
       caption = "Source: WEO, April 2017 and ECLAC. Simple averages of country-level trend GDP growth rates.\n For each country, trend GDP is obtained by filtering real GDP, using a HP filter.") +
  guides(color = guide_legend(ncol = 2)) + 
  theme(legend.position = "bottom",
         plot.title = element_text(hjust = 0.5), 
         plot.subtitle = element_text(hjust = 0.5),
         plot.caption = element_text(size = 8, hjust = 0),
         legend.key.size = unit(0.4, "cm")) 


plot_manuf_uwavg_gr <- ggplot( filter(gr_groups_filters_pfun, exp_group == "manuf") , aes(x = year(date.fil))) +   geom_line(aes(y = uw_gr_hp, col = "HP"), size = 1.3) + 
  geom_line(aes(y = uw_gr_pfun, col = "Prod function"), size = 1.3) + 
  labs(title = "PIB potencial, exporters of manufactures",
       x = "",
       y = "Crecimiento anual (%)") + 
   theme_classic2() +
   theme(plot.title = element_text(hjust = 0.5)) + 
  scale_x_continuous(breaks = xticks)


plot_mining_uwavg_gr <- ggplot( filter(gr_groups_filters_pfun, exp_group == "mining") , aes(x = year(date.fil))) +   geom_line(aes(y = uw_gr_hp, col = "HP"), size = 1.3) + 
  geom_line(aes(y = uw_gr_pfun, col = "Prod function"), size = 1.3) + 
  labs(title = "PIB potencial, exporters of metals",
       x = "",
       y = "Crecimiento anual (%)") + 
   theme_classic2() +
   theme(plot.title = element_text(hjust = 0.5)) + 
  scale_x_continuous(breaks = xticks)


plot_oil_uwavg_gr <- ggplot( filter(gr_groups_filters_pfun, exp_group == "oil") , aes(x = year(date.fil))) +   geom_line(aes(y = uw_gr_hp, col = "HP"), size = 1.3) + 
  geom_line(aes(y = uw_gr_pfun, col = "Prod function"), size = 1.3) + 
  labs(title = "PIB potencial, exporters of hidrocarburs",
       x = "",
       y = "Crecimiento anual (%)") + 
   theme_classic2() +
   theme(plot.title = element_text(hjust = 0.5)) + 
  scale_x_continuous(breaks = xticks)


plot_agro_uwavg_gr <- ggplot( filter(gr_groups_filters_pfun, exp_group == "agro") , aes(x = year(date.fil))) +   geom_line(aes(y = uw_gr_hp, col = "HP"), size = 1.3) + 
  geom_line(aes(y = uw_gr_pfun, col = "Prod function"), size = 1.3) + 
  labs(title = "PIB potencial, exporters of agriculture",
       x = "",
       y = "Crecimiento anual (%)") + 
   theme_classic2() +
   theme(plot.title = element_text(hjust = 0.5)) + 
  scale_x_continuous(breaks = xticks)


# list_of_group_gr_plots = list_along(clasif)
# names(list_of_group_gr_plots) <- names(clasif)
# 
# for (grupo in clasif) {
#   crit <- real_gdp_lcu_filters_pfun$iso2c %in% grupo & real_gdp_lcu_filters_pfun$year >=1990 & real_gdp_lcu_filters_pfun$year<= 2015
#   
#   df <- real_gdp_lcu_filters_pfun[crit, ]
#   
#   gr_group_filters_pfun <- df %>% 
#   group_by(date.fil) %>% 
#   summarise(w_gr_pfun = sum(100*growth_pot_gdp*pond),
#             w_gr_pfun_hp = sum(100*hp_trend.p_fun*pond),
#             w_gr_hp = sum(hp_trend_growth_pct*pond),
#             w_gr_cf = sum(cf_trend_growth_pct*pond),
#             w_gr_actual_gdp = sum(actual_gdp_growth_pct*pond),
#             uw_gr_actual_gdp = mean(actual_gdp_growth_pct),
#             uw_gr_hp = mean(hp_trend_growth_pct),
#             uw_gr_pfun = mean(100*growth_pot_gdp),
#             uw_gr_pfun_hp = mean(100*hp_trend.p_fun)) %>% 
#   ungroup() %>% 
#   filter(year(date.fil) >= 1990 & year(date.fil) <= 2015)
#   
#   group_plot_base <- ggplot(gr_group_filters_pfun, aes(x = year(date.fil))) + 
#   geom_line(aes(y = uw_gr_hp, col = "HP"), size = 1.3) + 
#    theme_classic2() +
#   labs(title = paste("PIB potencial ", grupo[[1]]  ),
#        x = "",
#        y = "Crecimiento anual (%)")  +
#   theme(legend.position = "none", plot.title = element_text(hjust = 0.5)) + 
#   scale_x_continuous(breaks = xticks)
#   
#   group_plot <- group_plot_base 
#   
#   print(group_plot)
# 
#   list_of_gr_plots[grupo] <- group_plot  
# }





plot_lac18_wavg_gr_base <- ggplot(gr_lac_filters_pfun, aes(x = year(date.fil))) + 
  geom_line(aes(y = w_gr_hp, col = "HP"), size = 1.3) + 
  labs(title = "PIB potencial",
       x = "",
       y = "Crecimiento anual (%)") + 
   theme_classic2() +
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5)) + 
  scale_x_continuous(breaks = xticks)

plot_lac18_wavg_gr_base_hp_pfun <- plot_lac18_wavg_gr_base  + 
  geom_line(aes(y = w_gr_pfun_hp, col = "Prod fun hped"), size = 1.3)

plot_lac18_wavg_gr_with_actual <- plot_lac18_wavg_gr_base_hp_pfun + 
  geom_line(aes(y = w_gr_actual_gdp, col = "actual gdp")) + 
  geom_line(aes(y = w_gr_pfun, col = "Prod fun"))  



plot_lac18_uwavg_gr_base <- ggplot(gr_lac_filters_pfun, aes(x = year(date.fil))) + 
  geom_line(aes(y = uw_gr_hp, col = "HP"), size = 1.3) + 
  labs(title = "Trend GDP",
       x = "",
       y = "Crecimiento anual (%)") + 
   theme_classic2() +
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5)) + 
  scale_x_continuous(breaks = xticks)

plot_lac18_uwavg_gr_pfun <- ggplot(gr_lac_filters_pfun, aes(x = year(date.fil))) + 
  geom_line(aes(y = uw_gr_pfun, col = "HP"), size = 1.3) + 
  labs(title = "Potential GDP",
       x = "",
       y = "Crecimiento anual (%)") + 
   theme_classic2() +
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5)) + 
  scale_x_continuous(breaks = xticks)

plot_lac18_uwavg_gr_hp_pfun <- plot_lac18_uwavg_gr_base  + 
  geom_line(aes(y = uw_gr_pfun, col = "Prod fun"), size = 1.3) + 
  labs(title = "HP vs production function, simple averages of growth rates",
       x = "",
       y = "Crecimiento anual (%)") + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))
  

plot_lac18_uwavg_gr_with_actual <- plot_lac18_uwavg_gr_base_hp_pfun + 
  geom_line(aes(y = uw_gr_actual_gdp, col = "actual gdp")) + 
  geom_line(aes(y = uw_gr_pfun, col = "Prod fun"))  


plot_lac16_uwavg_gr_base <- ggplot(gr_lac16venbra_filters_pfun, aes(x = year(date.fil))) + 
  geom_line(aes(y = uw_gr_hp, col = "HP"), size = 1.3) + 
  labs(title = "LAC 16, Trend GDP",
       x = "",
       y = "Crecimiento anual (%)") + 
   theme_classic2() +
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5)) + 
  scale_x_continuous(breaks = xticks)

plot_lac16_uwavg_gr_base<- ggplot(gr_lac16venbra_filters_pfun, aes(x = year(date.fil))) + 
  geom_line(aes(y = uw_gr_pfun, col = "HP"), size = 1.3) + 
  labs(title = "LAC 16, Potential GDP",
       x = "",
       y = "Crecimiento anual (%)") + 
   theme_classic2() +
   theme(legend.position = "none", plot.title = element_text(hjust = 0.5)) + 
  scale_x_continuous(breaks = xticks)

plot_lac16_uwavg_gr_hp_pfun <- plot_lac16_uwavg_gr_base  + 
  geom_line(aes(y = uw_gr_pfun, col = "Prod fun"), size = 1.3) + 
  labs(title = "HP vs production function, simple averages of growth rates",
       x = "",
       y = "Crecimiento anual (%)") + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))
  

plot_lac16_uwavg_gr_with_actual <- plot_lac16_uwavg_gr_hp_pfun + 
  geom_line(aes(y = uw_gr_actual_gdp, col = "actual gdp")) + 
  geom_line(aes(y = uw_gr_pfun, col = "Prod fun"))  

plot_lac18vs16_pfun <- ggplot(gr_lac16venbra_filters_pfun, aes(x = year(date.fil))) + 
  geom_line(aes(y = uw_gr_pfun, col = "Lac-16"), size = 1.3) + 
  geom_line(data = gr_lac_filters_pfun, aes(y = uw_gr_pfun, col = "Lac-18"), size = 1.3) +
  labs(title = "Potential GDP",
       x = "",
       y = "Crecimiento anual (%)") + 
   theme_classic2() +
   theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5)) + 
  scale_x_continuous(breaks = xticks)


plot_lac18vs16_hp <- ggplot(gr_lac16venbra_filters_pfun, aes(x = year(date.fil))) + 
  geom_line(aes(y = uw_gr_hp, col = "Lac-16"), size = 1.3) + 
  geom_line(data = gr_lac_filters_pfun, aes(y = uw_gr_hp, col = "Lac-18"), size = 1.3) +
  labs(title = "Trend GDP",
       x = "",
       y = "Crecimiento anual (%)") + 
   theme_classic2() +
   theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5)) + 
  scale_x_continuous(breaks = xticks)



plot_bra_chgs_pfunhp <-  ggplot(data = filter(real_gdp_lcu_filters_pfun, 
                                       iso == "BRA" & year >= 1990 & year <= 2015), 
                   aes(x = date.fil, y = actual_gdp_growth_pct)) + geom_line() + 
  geom_line(aes(y = hp_trend_growth_pct), col = "blue") +
  geom_line(aes(y = cf_trend_growth_pct), col = "red") + 
  geom_line(aes(y = 100*growth_pot_gdp), col = "green") + 
  geom_line(aes(y = 100*hp_trend.p_fun), col = "yellow")


# list_of_gr_plots = list_along(cepal_18_countries$iso2c)
# names(list_of_gr_plots) <- cepal_18_countries[["iso2c"]]
# 
# for (co in cepal_18_countries[["iso2c"]]) {
#   crit <- real_gdp_lcu_filters_pfun$iso2c == co & real_gdp_lcu_filters_pfun$year >=1990 & real_gdp_lcu_filters_pfun$year<= 2015
#   
#   df <- real_gdp_lcu_filters_pfun[crit, ]
#   co_plot <- ggplot(data = df, aes(x = date.fil, y = actual_gdp_growth_pct)) + 
#     geom_line() + 
#   geom_line(aes(y = hp_trend_growth_pct), col = "blue") +
#   geom_line(aes(y = 100*hp_trend.p_fun), col = "green") + 
#     ggtitle(co)
#   
#   # print(co_plot)
# 
#   list_of_gr_plots[co] <- co_plot  
# }

plot_lac18_wavg_gr_base
plot_lac18_uwavg_gr_base
plot_lac18_uwavg_gr_base_hp_pfun
plot_lac18_uwavg_gr_with_actual


plot_groups_uwavg_gr_hp
plot_groups_uwavg_gr_pfun


```




```{r table_avg_tg_lac, echo=FALSE, results=TRUE}
lac_tbl_caption = "Average growth of potential output, LAC"
uno_colnames = c("país"," 2003-2008 ", " 2010-2016 ", " cambio ")
knitr::kable(trend_growth_2003_2008_2010_2016_lac, digits = 1,
             col.names = uno_colnames, caption = lac_tbl_caption) %>% 
  add_footnote("Source: Real GDP growth and out gap from WEO April 2017.  Potential GDP growth, authors' calculations")
```


Después de la gran crisis financiera global (2007-2008) y el posterior derrumbe de los precios de los commodities (2009), la región retomó tasas positivas de crecimiento pero a un ritmo notablemente menor que en el quinquenio 2003-2008. Un cálculo de los PIB tendenciales y su tasa de crecimiento, muestra que prácticamente para todos los países de ALC, la realidad post-2009 involucra tasas de crecimeinto tendencial o potencial bastante menores al mundo pre-crisis, particularmente agudo en los casos de Venezuela, Argentina y Brasil, con pocas pero notables excepciones como Bolivia, Nicaragua y Paraguay.  


En nuestra muestra, sólo en 3 de 18 países, el PIB potencial exhibe mayor dinamismo en el período post-2009. Casi en la mitad de los países (8 de 18)  el PIB potencial pierde en promedio 100 o más puntos base de crecimiento cada año.


El caso de México es interesante porque exhibe tasas de crecimiento del PIB potencial esencialmente iguales (y modestas) en ambos períodos, probablemente debido a que sus exportaciones están concentradas en manufacturas y no en commodities y también debido a que la desaceleración de Estados Unidos, su principal socio comercial por lejos, aunque real, no es tan pronunciada como la desaceleración de China, que tiende a tener un mayor peso en la exportaciones de los países América del Sur.

Esta nueva realidad que enfrenta la región no es por supuesto, un mal endémico: es parte de un contexto interacional de desaceleración, tal como puede verse en el segundo cuadro: Estados Unidos, China, la zona del euro (sus tres principales socios comerciales) y el conjunto de las economías avanzadas (IMF classification) también exhiben menores tasa de crecimiento de sus PIB tendeciales en igual período. Es cierto aún para los Estado Unidos, donde incluímos el año 2008 en el primer período, cuando la crisis ya golpeaba al sector real. Los dos números que resumen este panorama son los de las Economías Avanzadas  y China. En el caso del las economías avanzadas pasamos de un crecimiento potencial de 2.1% promedio a 1.4% y China que pasa de 11.2% a 8%.


```{r table_avg_tg_bigeconomies, echo=FALSE, results=TRUE}

tbl_be_caption = "Average growth of potential output, advanced economies and China"
knitr::kable(trend_growth_2003_2008_2010_2016_big_economies, digits = 1,
             col.names = uno_colnames, caption = tbl_be_caption) %>% 
  add_footnote("Source: Real GDP growth and out gap from WEO April 2017.  Potential GDP growth, authors' calculation")
```


```{r avg_tg_barplot_lac, fig.width=12, fig.height=12}
lac_data <- trend_growth_2003_2008_2010_2016 %>% 
  filter(!country %in% c("China", "United States"))  %>% 
  mutate(country = factor(country),
         country = reorder(country, avg_tg_2003_2008)
         ) %>% 
  gather(key = period, value = avg_growth,
         avg_tg_2003_2008, avg_tg_2010_2016) %>% 
  mutate(period = factor(period, 
                         levels = c("avg_tg_2010_2016", 
                                    "avg_tg_2003_2008"))) %>% 
  arrange(country, period)


bp_lac <- ggplot(lac_data, aes(x = country, y = avg_growth, fill = period)) + 
  geom_bar(stat = "identity", position = "dodge") + 
  coord_flip() + ggtitle("Potential output growth, LAC") + 
  ylab("Average growth (%)") + xlab("") + 
  scale_fill_discrete(labels = c("2010 - 2016", "2003 - 2008")) +
  scale_y_continuous(breaks=seq(-2, 12, 2)) +
  theme_tufte() +
  theme(axis.text = element_text(size = 17),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 17),
        title = element_text(size = 19)) 

bp_lac
```



```{r avg_tg_barplot_not_lac}
 not_lac_data <- trend_growth_2003_2008_2010_2016_big_economies %>% 
  mutate(country = factor(country),
         country = reorder(country, avg_tg_2003_2008)
         ) %>% 
  gather(key = period, value = avg_growth,
         avg_tg_2003_2008, avg_tg_2010_2016) %>% 
  mutate(period = factor(period, 
                         levels = c("avg_tg_2010_2016", 
                                    "avg_tg_2003_2008"))) %>% 
  arrange(country, period)


bp_not_lac <- ggplot(not_lac_data, aes(x = country, y = avg_growth, fill = period)) + 
  geom_bar(stat = "identity", position = "dodge") + 
  coord_flip() + ggtitle("Potential output growth, Advanced economies and China") + 
  ylab("Average growth (%)") + xlab("") + 
  scale_fill_discrete(labels = c("2010 - 2016", "2003 - 2008")) +
  scale_y_continuous(breaks = seq(-2, 12, 2)) +
  theme_tufte()

```



## Comercio

### Exportaciones e Importaciones

```{r calcultate_avg_gr_trade_related, include=FALSE}

# "TM_RPCH": Volume of imports of goods and services, Percent change 
# "TMG_RPCH": Volume of Imports of goods, Percent change 
# "TX_RPCH": Volume of exports of goods and services Percent change 
# "TXG_RPCH": Volume of exports of goods, Percent change 
# "BCA_NGDPD": Current account balance, Percentage of GDP

weo_trade <- WEOApr2017cepal18_others_long %>% 
  select(iso, country, year, weo_subject_code, value) %>% 
  filter(weo_subject_code %in% c("TM_RPCH", "TMG_RPCH", "TX_RPCH", "TXG_RPCH",
                                 "BCA_NGDPD")) %>% 
  arrange(country, year, weo_subject_code)

weo_trade_avg_2003_2008 <-  weo_trade %>% 
  spread(key=weo_subject_code, value=value) %>% 
  filter(year >= 2003 & year <= 2008) %>% 
  group_by(country) %>% 
  summarise(avg_gr_x_2003_2008 = mean(TX_RPCH, na.rm = TRUE),
            avg_gr_xg_2003_2008 = mean(TXG_RPCH, na.rm = TRUE),
            avg_gr_m_2003_2008 = mean(TM_RPCH, na.rm = TRUE),
            avg_gr_mg_2003_2008 = mean(TMG_RPCH, na.rm = TRUE))

weo_trade_avg_2010_2016 <-  weo_trade %>% 
  spread(key=weo_subject_code, value=value) %>% 
  filter(year >= 2010 & year <= 2016) %>% 
  group_by(country) %>% 
  summarise(avg_gr_x_2010_2016 = mean(TX_RPCH, na.rm = TRUE),
            avg_gr_xg_2010_2016 = mean(TXG_RPCH, na.rm = TRUE),
            avg_gr_m_2010_2016 = mean(TM_RPCH, na.rm = TRUE),
            avg_gr_mg_2010_2016 = mean(TMG_RPCH, na.rm = TRUE))

weo_trade_avg_02_08_10_16 <- left_join(weo_trade_avg_2003_2008,
                                       weo_trade_avg_2010_2016,
                                       by = c("country")) 

weo_ggss_avg_02_08_10_16 <- weo_trade_avg_02_08_10_16 %>% 
  select(country, avg_gr_x_2003_2008, avg_gr_x_2010_2016,
         avg_gr_m_2003_2008, avg_gr_m_2010_2016)


weo_gg_avg_02_08_10_16 <- weo_trade_avg_02_08_10_16 %>% 
  select(country, avg_gr_xg_2003_2008, avg_gr_xg_2010_2016,
         avg_gr_mg_2003_2008, avg_gr_mg_2010_2016)

weo_gg_avg_02_08_10_16_lac <- weo_gg_avg_02_08_10_16  %>% 
  filter(country  %in% weo_country_names_lac_18)

weo_gg_avg_02_08_10_16_ae_usa_china_ez <- weo_gg_avg_02_08_10_16  %>% 
  filter(country  %in% c("China", "United States", "Euro area", "Advanced economies"))

chl_trade <- weo_trade %>% filter(iso == "CHL")
chn_trade <- weo_trade %>% filter(iso == "CHN")
```



```{r table_avg_tg_lac_foo, echo=FALSE, results=TRUE}
xm_gg_colnames = c("Economy", "Exports 2003-2008", "Exports 2010-2016",
                   "Imports 2003-2008", "Imports 2010-2016")

tbl_gg_lac_caption = "Average growth exports and imports of goods (LAC-18)"
knitr::kable(weo_gg_avg_02_08_10_16_lac, digits = 1,
             col.names = xm_gg_colnames, caption = tbl_gg_lac_caption) %>% 
  add_footnote("Source: growth rates for each year from WEO April 2017")
```

En casi todas las economías de la región, vemos una considerable desaceleración de sus exportaciones 
(medidas por el volumen de exportación) respecto del período 2003-2008. En el período más reciente sólo 5 de las 18 economías lograron expandir sus exportaciones a un promedio mayor al 5% anual y ninguna alcanza crecimientos promedios de dos dígitos, mientras que durante el quinquenio pre-crisis seis de ellas crecían por sobre el 10% anual y 11 de ellas crecen cómodamente más de 5% al año. Y aquellas que mejoran su desempeño en el segundo período, vienen de desempeños m+as bien modestos durante 2003-2008.

Todas las excepciones se encuentran fuera de América del Sur, pero el panorama está lejos de ser homogéneo, pues junto a los casos de México, Honduras, Guatemala y notablemente Republica Dominicana --que pasa de una contracción promedio a una ráida expansión promedio-- que lograron incrementar la velocidad de expansión de sus exportaciones, están también los casos de Nicaragua, Costa Rica, Panamá y EL Salvador que sufrieron un freno importante en su sector exportador. Después de República Dominicana, es México quien presenta el caso más interesante: tiene un sólido incremento de la tasa de crecimiento de sus exportaciones y se ubica en esta nueva etapa como la segunda economía más dinámica 

En el caso de la importaciones tenemos una situación muy similar a las de las exportaciones: las única economías que han logrado aumentar la tasa de expansión de sus importaciones son las mismas que lograron acelerar su sector exportador, menos Honduras, que se suma en este caso al grupo mayoritario de países que desaceleran.

Esta tendencia general de América Latina, coincide con los patrones de crecimiento del comercio de las Economías Avanzas, China y Estados Unidos, con la sola pero potencialmente importante excepción las importaciones de los Estados Unidos, que se aceleraron levemente después de la crisis: pasaron de crecer a un 4.5% promedio anual a un 4.9% promedio anual. Sin duda, el cambio más importante para el producto pontencial de AL y especialemente de los exportadores de commodities es la ralentización de las importaciones chinas, que pasaron de crecer en promedio 17% al año a un 8.4% en el segundo período. 


```{r table_avg_trade_bigeconomies, echo=FALSE, results=TRUE}

tbl_gg_be_caption = "Average growth exports and imports of goods (Advanced economies and China)"
knitr::kable(weo_gg_avg_02_08_10_16_ae_usa_china_ez, digits = 1,
             col.names = xm_gg_colnames, caption = tbl_gg_be_caption) %>% 
  add_footnote("Source: growth rates for each year from WEO April 2017")
```


### Commodity prices


```{r compute_commodity_price, include=FALSE}

# PMETAW, World, Commodity Metals Price Index includes Copper, Alumin, Index, 2005=100
# PCOPP, World, Copper, grade A cathode, LME spot price, CIF European ... in U.S. dollars 
# PALLFNFW, World, Commodity Price Index includes both Fuel and Non-Fuel Price Indices, Index, 2005=100
# POILAPSPW, World, Crude Oil (petroleum), Price index simple average of three spot prices (APSP); Dated Brent, West Texas Intermediate, and the Dubai Fateh, Index, 2005=100
# 
# PCOFFW, World, Commodity Coffee Price Index includes Other Mild Arabicas and Robusta,Index, 2005=100
# PNGASW, World, Commodity Natural Gas Price Index includes European, Japanese, and American Natural Gas Price Indices, Index, 2005=100
# PNRGW, World, Commodity Fuel (energy) Index includes Crude oil (petroleum), Natural Gas, and Coal Price Indices, Index, 2005=100
# PVOILW, World, Commodity Vegetable Oil Index includes Soybean, Soybean Meal, Soybean Oil, Rapeseed Oil, Palm Oil, Sunflower Oil, Olive Oil, Fishmeal, and Groundnut Price Indices, Index, 2005=100
# PFOODW, World, Commodity Food Price Index includes Cereal, Vegetable Oils, Meat, Seafood, Sugar, Bananas, and Oranges Price Indices Index, 2005=100

my_growth <- function(x) {
  pg <- 100*(x - dplyr::lag(x))/ dplyr::lag(x)
}

weo_commo <- WEOApr2017cepal18_others_long %>% 
  filter(country == "World") %>% select(weo_subject_code, year, value) %>% 
  filter(weo_subject_code %in% c("PMETAW", "PCOPP", "PALLFNFW", "POILAPSPW",
                                 "PCOFFW", "PNGASW", "PNRGW", "PVOILW", "PFOODW")) %>% 
  arrange(weo_subject_code, year) %>%   
  group_by(weo_subject_code) %>% 
  mutate(pct_growth = my_growth(value)) 

weo_commo_g_avg_2003_2008 <- weo_commo %>% 
  filter(year >= 2003 & year <= 2008) %>% 
  select(-value) %>% 
  summarise(avg_gr_2003_2008 = mean(pct_growth, na.rm = TRUE))

weo_commo_g_avg_2010_2016 <- weo_commo %>% 
  filter(year >= 2010 & year <= 2016) %>% 
  select(-value) %>% 
  summarise(avg_gr_2010_2016 = mean(pct_growth, na.rm = TRUE))
  
weo_commo_g_avg_03_08_10_16 <- left_join(weo_commo_g_avg_2003_2008,
                                         weo_commo_g_avg_2010_2016,
                                         by = "weo_subject_code" ) %>% 
  mutate(cambio = avg_gr_2010_2016 - avg_gr_2003_2008)

```

En cuanto al precio de los commodities, si bien es cierto que en todos los grupos de bienes 
se observa un quiebre brutal en sus trayectorias pre y post 2009 (todos pasas de crecer vigorosamente a tasas de crecimiento muy tímidas o de pequeñas contracciones) es en el caso de los hidrocarburos y los metales, donde el freno ha sido más fuerte: mientras que el grupo de los alimentos pasa de crecer desde un robusto 11.6% anual a un exiguo 1.6% en el segundo período, para los metales e hidrocarburos la caída es desde impresionantes 25% a expansiones nulas (metales) o caídas moderadas (gas y petróleo).


```{r table_comm_price_gr_avg}

selected_comm <- c("PMETAW", "POILAPSPW", "PNGASW", "PFOODW")

colnames_comm_table <- c("Commodity", "2003-2008", "2010-2016", "Cambio")

comm_table_data <- weo_commo_g_avg_03_08_10_16 %>% 
  filter(weo_subject_code %in% selected_comm)

comm_table_data[ , 1] <- c("Food", "Metals", "Gas", "Oil")

tbl_comm_gr_caption = "Growth commodity price indexes (%)"

knitr::kable(comm_table_data , digits = 1,
             col.names = colnames_comm_table, caption = tbl_comm_gr_caption) %>% 
  add_footnote("Source: Price indexes (2005=100) for each year, from WEO April 2017")

```

## Formación de capital

```{r fbc}
load("../produced_data/cs_fbcf_ratio_pib")
load("../produced_data/gfcf_wb_data")



cgr <- cs_fbcf_ratio_pib %>% 
  select(iso3c, fbc_gr, fbcf_gr, year)

cf_gr_03_08 <- cgr %>% 
  select(-fbc_gr) %>% 
  filter(year >= 2003 & year <= 2008) %>% 
  group_by(iso3c) %>% 
  summarise(avg_03_08 = mean(fbcf_gr, na.rm = TRUE))

cf_gr_10_16 <- cgr %>% 
  select(-fbc_gr) %>% 
  filter(year >= 2010 & year <= 2016) %>% 
  group_by(iso3c) %>% 
  summarise(avg_10_16 = mean(fbcf_gr, na.rm = TRUE))

fbcf_avg_gr_03_08_10_16 <- left_join(cf_gr_03_08,
                                     cf_gr_10_16,
                                         by = "iso3c" ) %>% 
  mutate(cambio = avg_10_16 - avg_03_08)



```

La enorme mayoría -- 14 de 18-- de los países de la región en nuestra muestra vieron una 
desaceleración de la inversión real (medida por el gasto real en formación 
de capital fijo) en este segundo período. De las cuatro excepciones, una de ellas -- Guatemala -- pasó de una tasa de crecimiento modesta a una un tanto mayor (3,3% a 4,4%), pero sólo en los casos de Bolivia, Nicaragua and Panamá pudieron sostener y mejorar altas tasas de crecimiento de la inversión. 

Dentro de la mayoría de los países donde la inversión se frena durante el segundo período, destacan Argentina, Brasil, Chile y Perú. En el caso de estos dos últimos países, se trata de exportadores de metales, grupo de commodities que como ya vimos se caracterizó grandes fluctuaciones en su precio y que estancó su crecimiento en el segundo período, lo que sin duda repercutió en los planes de inversión.


```{r gfcf_lac_table}


colnames_fbcf_table <- c("", "2003-2008", "2010-2015", "Cambio")

fbcf_table_data <- gfcf_gr_03_08_10_15 %>% 
  filter(iso2c %in% cepal_18_countries[["iso2c"]]) %>%
  select(iso2c, gfcf_gagr_03_08, gfcf_gagr_10_15, cambio_gm)


tbl_fbcf_gr_caption = "Growth Gross Fixed Cap formation, lac 18 (%)"

knitr::kable(fbcf_table_data , digits = 1,
             col.names = colnames_fbcf_table, caption = tbl_fbcf_gr_caption) %>% 
  add_footnote("Source: WB")

```



```{r gfcf_notlac_table}

colnames_fbcf_table <- c("", "2003-2008", "2010-2015", "Cambio")

not_cepal_countries <- c("USA", "CHN", "RUS", "JPN", "IND", "DEU", "GBR") 
aggregates_codes <-  c("WLD", "LCN", "OED", "EMU", "EUU", "LAC", "LCN", "LCR", "HIC")

other_iso2c <- countrycode(c(not_cepal_countries,aggregates_codes),
                           "iso3c", "iso2c")

fbcf_table_data_notlac <- gfcf_gr_03_08_10_15 %>% 
  filter(iso2c %in% other_iso2c) %>%
  select(iso2c, gfcf_gagr_03_08, gfcf_gagr_10_15, cambio_gm)


tbl_fbcf_gr_caption_notlac = "Growth Gross Fixed Cap formation, other economies (%)"

knitr::kable(fbcf_table_data_notlac , digits = 1,
             col.names = colnames_fbcf_table,
             caption = tbl_fbcf_gr_caption_notlac) %>% 
  add_footnote("Source: WB")

```


## Productivity

```{r labor_produc_dfs}

load("../produced_data/gdp_employ_pop_wb_pwt_ted")
gdp_hrs_worked_ppp_oecd <- read_excel("../raw_data/gdp_hrs_worked_ppp_oecd.xlsx")


not_cepal_countries <- c("USA", "CHN", "RUS", "JPN", "IND", "DEU", "GBR") 
aggregates_codes <-  c("WLD", "LCN", "OED", "EMU", "EUU", "LAC", "LCN", "LCR", "HIC")
this_selection_18 <- c(cepal_18_countries[["iso3c"]], not_cepal_countries, aggregates_codes)

wb_agg_cnames = c("World", "High Income", "OECD members", "Euro area", 
                  "Latin America & Caribbean" )

from_pwt <- pwt_gdp_per_employed %>% 
  select(isocode, country, year, growth_gdp_to_pop_pwt, growth_gdp_to_emp_pwt) %>% 
  filter(year >= 1990) %>% 
  rename(iso3c = isocode)

from_wb <- gdp_per_employed %>% 
  ungroup() %>% 
  select(iso3c, country, date, growth_gdp_per_pop, growth_gdp_per_emp) %>% 
  rename(year = date) %>% 
  mutate(iso3c = factor(iso3c),
         year = as.integer(year)) %>% 
  filter(year >= 1990)

from_ted <- ted_gracc_data

lp_growth_emp_wb_pwt <- left_join(from_wb, from_pwt, by = c("iso3c", "year")) %>% 
  select(iso3c, year, growth_gdp_per_emp, growth_gdp_to_emp_pwt) %>% 
  filter(iso3c %in% factor(this_selection_18))

lp_growth_pop_wb_pwt <- left_join(from_wb, from_pwt, by = c("iso3c", "year")) %>% 
  select(iso3c, year, growth_gdp_per_pop, growth_gdp_to_pop_pwt) %>% 
  filter(iso3c %in% factor(this_selection_18))

lp_growth_avgs_92_00 <-lp_growth_emp_wb_pwt %>% 
  filter(year >= 1992 & year <= 2000) %>% 
  group_by(iso3c) %>% 
  summarise(avg_lp_gr_92_00_wb = mean(growth_gdp_per_emp, na.rm = TRUE),
            avg_lp_gr_92_00_pwt = mean(growth_gdp_to_emp_pwt, na.rm = TRUE))

lp_growth_avgs_03_08 <-lp_growth_emp_wb_pwt %>% 
  filter(year >= 2003 & year <= 2008) %>% 
  group_by(iso3c) %>% 
  summarise(avg_lp_gr_03_08_wb = mean(growth_gdp_per_emp, na.rm = TRUE),
            avg_lp_gr_03_08_pwt = mean(growth_gdp_to_emp_pwt, na.rm = TRUE))


lp_growth_avgs_10_15 <-lp_growth_emp_wb_pwt %>% 
  filter(year >= 2010 & year <= 2015) %>% 
  group_by(iso3c) %>% 
  summarise(avg_lp_gr_10_15_wb = mean(growth_gdp_per_emp, na.rm = TRUE),
            avg_lp_gr_10_15_pwt = mean(growth_gdp_to_emp_pwt, na.rm = TRUE))  


lp_growth_avgs_92_to_15 <- left_join(lp_growth_avgs_92_00, 
                                     lp_growth_avgs_03_08, by = "iso3c") %>% 
  left_join(lp_growth_avgs_10_15, by = "iso3c") %>% 
  mutate(pwt_cambio_92_00_02_08 = avg_lp_gr_03_08_pwt - avg_lp_gr_92_00_pwt,
         wb_cambio_92_00_02_08 = avg_lp_gr_03_08_wb - avg_lp_gr_92_00_wb,
         pwt_cambio_03_08_10_15 = avg_lp_gr_10_15_pwt - avg_lp_gr_03_08_pwt,
         wb_cambio_03_08_10_15 = avg_lp_gr_10_15_wb - avg_lp_gr_03_08_wb)


lp_growth_diff_wb_vs_pwt  <- lp_growth_avgs_92_to_15 %>% 
  select(iso3c, pwt_cambio_03_08_10_15, wb_cambio_03_08_10_15) %>% 
  mutate(pwt_minus_wb = pwt_cambio_03_08_10_15 - wb_cambio_03_08_10_15,
         sign_reversal = pwt_cambio_03_08_10_15*wb_cambio_03_08_10_15 < 0)




```


Mirando a la región, el caso de la productividad del trabajo es un tanto distinto a las variables que hemos descrito hasta aquí. Comparte, por un lado, el de hecho de emperar en el período post crisis pero a diferencia de las otras, las tasas de crecimeinto son modestas en *ambos* períodos. No hubo un boom de productividad del trabajo junto con el boom de producción, inversión y exportación.

Aquellos paises que lograron acelerar un poco su productividad laboral en el segundo perìodo son Bolivia, Ecuador, Nicargua, Panamá, Paraguay y Uruguay

La anterior se sostiene tanto si consideramos los precios con o sin ajuste por PPP, pero en este último caso, los países que mejoraron su posición tienen a aparecer con mejoras más modestas que sin el ajuste por paridad de poder de compra. Los únicos casos donde es de alguna relevancia esta distinciòn son Perù y Colombia, que revierten una modesta caídad (Colombia) o un modesto aumento (Perù) si se mide su producciòn usando precios PPP.

Estos números están basado en el producto promedio por *persona empleada*. Sólo tenemos datos comparables de producto por *hora trabajada* en el caso de los dos países de LAC que son miembros de la OECD (México y Chile) y en ambos casos, 
la desaceleración de la prductividad del trabajo se hace más pronunciada, cuando medimos las horas trabajadas en vez de simplemente la cantidad de personas empleadas.

También es cierto, que la producividad o se estancó o se ralentizó en la mayoría de las economías más avanzadas o más importantes (China, USA, Alemania, UK) y donde a excepción de China, la desaceleracion de la productividad es un poco mayor si se mide en producto por hora trabajada.
  
  
```{r table_lac_lab_prod_gr_wb}
lp_wb_table_data <- lp_growth_avgs_92_to_15 %>% 
  select(iso3c, avg_lp_gr_03_08_wb, avg_lp_gr_10_15_wb, wb_cambio_03_08_10_15) %>% 
  filter(iso3c %in% factor(cepal_18_countries[["iso3c"]]))

colnames_lac_lp_wb_table <- c("", "2003-2008", "2010-2015", "Cambio")

tbl_lp_wb_caption = "Growth of labor productivity (GDP per employed)"

knitr::kable(lp_wb_table_data , digits = 1,
             col.names = colnames_lac_lp_wb_table , caption = tbl_lp_wb_caption) %>% 
  add_footnote("Source: World Bank, ILO")
  
```


```{r table_lac_lab_prod_gr_pwt}
lp_pwt_table_data <- lp_growth_avgs_92_to_15 %>% 
  select(iso3c, avg_lp_gr_03_08_pwt, avg_lp_gr_10_15_pwt,pwt_cambio_03_08_10_15) %>% 
  filter(iso3c %in% factor(cepal_18_countries[["iso3c"]]))

colnames_lac_lp_pwt_table <- c("", "2003-2008", "2010-2015", "Cambio")

tbl_lp_pwt_caption = "Growth of labor productivity (GDP per employed, at 2011 PPP values)"

knitr::kable(lp_pwt_table_data , digits = 1,
             col.names = colnames_lac_lp_pwt_table , caption = tbl_lp_pwt_caption) %>% 
  add_footnote("Source: PWT 9.0")
  
```


```{r table_other_countries_lab_prod_gr_pwt}
lp_pwt_table_data_not_cepal <- lp_growth_avgs_92_to_15 %>% 
  select(iso3c, avg_lp_gr_03_08_pwt, avg_lp_gr_10_15_pwt,pwt_cambio_03_08_10_15) %>% 
  filter(iso3c %in% factor(c(not_cepal_countries, aggregates_codes))  )

colnames_notlac_lp_pwt_table <- c("", "2003-2008", "2010-2015", "Cambio")

tbl_lp_pwt_caption = "Growth of labor productivity (GDP per employed, at 2011 PPP values)"

knitr::kable(lp_pwt_table_data_not_cepal , digits = 1,
             col.names = colnames_lac_lp_pwt_table , caption = tbl_lp_pwt_caption) %>% 
  add_footnote("Source: PWT 9.0")
  
```

 
```{r table_other_countries_lab_prod_gr_wb}
lp_wb_table_data_not_cepal <- lp_growth_avgs_92_to_15 %>% 
  select(iso3c, avg_lp_gr_03_08_wb, avg_lp_gr_10_15_wb, wb_cambio_03_08_10_15) %>% 
  filter(iso3c %in% factor(c(not_cepal_countries, aggregates_codes))  )

colnames_notlac_lp_wb_table <- c("", "2003-2008", "2010-2015", "Cambio")

tbl_lp_pwt_caption = "Growth of labor productivity (GDP per employed (2010 USD))"

knitr::kable(lp_wb_table_data_not_cepal , digits = 1,
             col.names = colnames_lac_lp_pwt_table , caption = tbl_lp_pwt_caption) %>% 
  add_footnote("Source: World Bank, ILO")
  
```



 
```{r table_oecd_hours_prod}
lp_oecd_table_data <- gdp_hrs_worked_ppp_oecd  

colnames_lp_oecd_table <- c("", "2003-2008", "2010-2015", "Cambio")

tbl_lp_oecd_caption = "Growth of labor productivity (GDP per hours worked (2011 PPP prices))"

knitr::kable(lp_oecd_table_data , digits = 1,
             col.names = colnames_lp_oecd_table , caption = tbl_lp_oecd_caption) %>% 
  add_footnote("Source: OECD")
  
```